<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chemotherapy Calculator Calendar</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 1000px;
    }
    .input-group {
      margin-bottom: 10px;
    }
    label {
      display: inline-block;
      width: 180px;
    }
    input, select {
      width: 200px;
      padding: 4px;
    }
    button {
      padding: 6px 12px;
      margin-right: 8px;
    }
    #results {
      margin-top: 20px;
      border-top: 1px solid #ccc;
      padding-top: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: center;
      vertical-align: top;
      font-family: monospace;
      white-space: pre-wrap;
    }
    pre {
      white-space: pre-wrap;
      font-family: monospace;
    }
    #calendar-container {
      overflow-x: auto;
    }
    #pharmacy-line {
      font-family: monospace;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <h1>Chemotherapy Calculator Calendar</h1>
  <div id="inputs">
    <div class="input-group">
      <label for="bsa">BSA (m²):</label>
      <input id="bsa" type="number" step="0.01" value="1.8" min="0">
    </div>
    <div class="input-group">
      <label for="mg-per-m2-day">Dose (mg/m²/day):</label>
      <input id="mg-per-m2-day" type="number" step="1" value="50" min="0">
    </div>
    <div class="input-group">
      <label for="days">Number of days:</label>
      <input id="days" type="number" step="1" value="21" min="1">
    </div>
    <div class="input-group">
      <label for="tablet-size">Tablet size (mg):</label>
      <input id="tablet-size" type="number" step="1" value="50" min="1">
    </div>
    <div class="input-group">
      <label for="schedule-mode">Schedule mode:</label>
      <select id="schedule-mode">
        <option value="front-load">Front-load overall</option>
        <option value="weekly-front-load">Weekly front-load</option>
        <option value="alternating">Alternating high/low</option>
      </select>
    </div>
    <button id="calculate">Calculate</button>
  </div>

  <div id="results" style="display:none;">
    <div class="section" id="provider-summary-section">
      <h2>Provider Summary</h2>
      <pre id="provider-summary"></pre>
    </div>

    <div class="section">
      <h2>Calendar</h2>
      <div id="calendar-container"></div>
    </div>

    <div class="section">
      <h2>Totals &amp; Sig</h2>
      <div id="totals"></div>
      <div id="pharmacy-line"></div>
      <button id="copy-pharmacy">Copy Sig</button>
    </div>

    <div class="section">
      <button id="export-provider">Export Provider (.rtf)</button>
      <button id="export-patient">Export Patient (.rtf)</button>
    </div>
  </div>

  <script>
    // Helper: escape non-ASCII to ASCII approximations for provider doc
    function asciiSanitize(str) {
      return str.replace(/²/g, '^2')
                .replace(/•/g, '*')
                .replace(/–/g, '-')
                .replace(/—/g, '-')
                .replace(/[“”]/g, '"')
                .replace(/[‘’]/g, "'");
    }

    // Helper: escape special chars for RTF (backslash, curly braces)
    function rtfEscape(str) {
      return str.replace(/\\/g, '\\\\')
                .replace(/\{/g, '\\{')
                .replace(/\}/g, '\\}')
                .replace(/\n/g, '\\line ');
    }

    // Compress contiguous runs of identical numbers into [{startDay, endDay, tabs}, ...]
    function compressRuns(arr) {
      const runs = [];
      if (arr.length === 0) return runs;
      let start = 1;
      let cur = arr[0];
      for (let i = 1; i < arr.length; i++) {
        if (arr[i] !== cur) {
          runs.push({ startDay: start, endDay: i, tabs: cur });
          start = i + 1;
          cur = arr[i];
        }
      }
      runs.push({ startDay: start, endDay: arr.length, tabs: cur });
      return runs;
    }

    // Check if the pattern strictly alternates two values [a, b, a, b, ...]
    function isStrictAlternating(arr) {
      if (arr.length < 2) return { alt: false, a: 0, b: 0 };
      const a = arr[0];
      const b = arr[1];
      if (a === b) return { alt: false, a: a, b: b };
      for (let i = 2; i < arr.length; i++) {
        const expect = (i % 2 === 0) ? a : b;
        if (arr[i] !== expect) return { alt: false, a: a, b: b };
      }
      return { alt: true, a: a, b: b };
    }

    // Detect a weekly front-load pattern: hi values first in each 7-day block, then lo values
    function detectWeeklyFrontload(arr) {
      const n = arr.length;
      if (n < 7) return null;
      const weeks = Math.floor(n / 7);
      const rem = n % 7;
      const values = Array.from(new Set(arr)).sort((x, y) => x - y);
      if (values.length !== 2) return null;
      const lo = values[0];
      const hi = values[1];
      const kVals = [];
      for (let w = 0; w < weeks; w++) {
        const week = arr.slice(w * 7, w * 7 + 7);
        let k = 0;
        while (k < 7 && week[k] === hi) k++;
        for (let i = k; i < 7; i++) {
          if (week[i] !== lo) return null;
        }
        kVals.push(k);
      }
      const kSet = new Set(kVals);
      if (kSet.size !== 1) return null;
      const k = kVals[0];
      if (rem > 0) {
        const tail = arr.slice(weeks * 7);
        const leadHi = Math.min(k, rem);
        for (let i = 0; i < leadHi; i++) {
          if (tail[i] !== hi) return null;
        }
        for (let i = leadHi; i < rem; i++) {
          if (tail[i] !== lo) return null;
        }
      }
      return { k: k, weeks: weeks, rem: rem, hi: hi, lo: lo };
    }

    // Format the pharmacy one-liner (Sig only, no quantity or tablet size)
    function formatPharmacySnippet(perDayTabs, days) {
      const uniqueTabs = Array.from(new Set(perDayTabs)).sort((a, b) => a - b);
      if (uniqueTabs.length === 1) {
        const t = uniqueTabs[0];
        return `Sig: Take ${t} tab(s) PO once daily for ${days} day${days === 1 ? '' : 's'}.`;
      }
      const runs = compressRuns(perDayTabs);
      if (runs.length === 2) {
        const [r1, r2] = runs;
        const part1 = (r1.startDay === r1.endDay)
          ? `Day ${r1.startDay}: ${r1.tabs} tab(s) PO`
          : `Days ${r1.startDay}-${r1.endDay}: ${r1.tabs} tab(s) PO daily`;
        const part2 = (r2.startDay === r2.endDay)
          ? `Day ${r2.startDay}: ${r2.tabs} tab(s) PO`
          : `Days ${r2.startDay}-${r2.endDay}: ${r2.tabs} tab(s) PO daily`;
        return `Sig: ${part1}; then ${part2}. Total ${days} day${days === 1 ? '' : 's'}.`;
      }
      const wf = detectWeeklyFrontload(perDayTabs);
      if (wf !== null) {
        const { k, weeks, rem, hi, lo } = wf;
        const segs = [];
        if (k > 0) segs.push(`Days 1-${k}: ${hi} tab(s) PO daily`);
        if (k < 7) segs.push(`Days ${k + 1}-7: ${lo} tab(s) PO daily`);
        const weekPattern = segs.join('; ');
        if (rem === 0) {
          return `Sig: Repeat weekly ×${weeks}: ${weekPattern}. Total ${days} day${days === 1 ? '' : 's'}.`;
        } else {
          const remParts = [];
          const remHi = Math.min(k, rem);
          if (remHi > 0) remParts.push(`Days 1-${remHi}: ${hi} tab(s) PO daily`);
          if (rem - remHi > 0) {
            const start = remHi + 1;
            remParts.push(`Days ${start}-${rem}: ${lo} tab(s) PO daily`);
          }
          return `Sig: Repeat weekly ×${weeks}: ${weekPattern}; then final ${rem} day${rem === 1 ? '' : 's'}: ${remParts.join('; ')}. Total ${days} day${days === 1 ? '' : 's'}.`;
        }
      }
      const alt = isStrictAlternating(perDayTabs);
      if (alt.alt) {
        return `Sig: Alternate ${alt.a} and ${alt.b} tab(s) PO daily, starting with ${alt.a}, for ${days} day${days === 1 ? '' : 's'}.`;
      }
      const segments = runs.map(r => {
        const label = (r.startDay === r.endDay) ? `Day ${r.startDay}` : `Days ${r.startDay}-${r.endDay}`;
        return `${label}: ${r.tabs} tab(s) PO daily`;
      });
      return `Sig: ${segments.join('; ')}. Total ${days} day${days === 1 ? '' : 's'}.`;
    }

    // Generate provider RTF content
    function generateProviderRtf(title, summary, pharmacyLine, calendarText, totalPills) {
      const esc = (s) => {
        const sanitized = asciiSanitize(s);
        return sanitized.replace(/\\/g, '\\\\')
                        .replace(/\{/g, '\\{')
                        .replace(/\}/g, '\\}')
                        .replace(/\n/g, '\\line ');
      };
      const header = '{\\rtf1\\ansi\\deff0{\\fonttbl{\\f0\\fmodern Courier New;}{\\f1\\fswiss Arial;}}' +
                     '\\sectd\\landscape\\paperw15840\\paperh12240\\margl720\\margr720\\margt720\\margb720';
      const body = '\\f0\\fs20 ' +
        '\\b ' + esc(title) + '\\b0\\line ' +
        '\\b Provider Summary\\b0\\line ' + esc(summary) + '\\line ' +
        'Total tablets to dispense: ' + totalPills + '\\line\\line ' +
        '\\b Sig\\b0\\line ' + esc(pharmacyLine) + '\\line\\line ' +
        '\\b Calendar\\b0\\line ' + esc(calendarText).replace(/\n/g, '\\line ');
      return header + body + '}';
    }

    // Generate patient RTF content
    function generatePatientRtf(patientIntro, calendarText, totalPills) {
      const esc = (s) => {
        return s.replace(/\\/g, '\\\\')
                .replace(/\{/g, '\\{')
                .replace(/\}/g, '\\}')
                .replace(/\n/g, '\\line ');
      };
      const header = '{\\rtf1\\ansi\\deff0{\\fonttbl{\\f0\\fmodern Courier New;}{\\f1\\fswiss Arial;}}' +
                     '\\sectd\\landscape\\paperw15840\\paperh12240\\margl720\\margr720\\margt720\\margb720';
      const body = '\\f0\\fs24 ' +
        '\\b Your Chemotherapy Tablet Schedule\\b0\\line ' +
        esc(patientIntro) + '\\line ' +
        'Total tablets for the course: ' + totalPills + '\\line\\line ' +
        '\\b Daily Plan\\b0\\line ' + esc(calendarText).replace(/\n/g, '\\line ');
      return header + body + '}';
    }

    // Build the calendar HTML string from perDayTabs
    function buildCalendar(perDayTabs, tabletSize) {
      const days = perDayTabs.length;
      let dayIndex = 0;
      let html = '<table>';
      html += '<tr>';
      for (let i = 1; i <= 7; i++) {
        html += `<th>D${i}</th>`;
      }
      html += '</tr>';
      while (dayIndex < days) {
        html += '<tr>';
        for (let col = 0; col < 7; col++) {
          if (dayIndex < days) {
            const d = dayIndex + 1;
            const tabs = perDayTabs[dayIndex];
            const mg = tabs * tabletSize;
            html += `<td>Day ${d}\n${tabs} tab(s)\n(${mg} mg)</td>`;
            dayIndex++;
          } else {
            html += '<td></td>';
          }
        }
        html += '</tr>';
      }
      html += '</table>';
      return html;
    }

    // Create calendar text for RTF: plain text table representation
    function buildCalendarText(perDayTabs, tabletSize) {
      const days = perDayTabs.length;
      let text = '';
      let dayIndex = 0;
      while (dayIndex < days) {
        const dayLabels = [];
        const tabLabels = [];
        const mgLabels = [];
        for (let col = 0; col < 7; col++) {
          if (dayIndex < days) {
            const d = dayIndex + 1;
            dayLabels.push(`Day ${d}`);
            const tabs = perDayTabs[dayIndex];
            tabLabels.push(`${tabs} tab(s)`);
            const mg = tabs * tabletSize;
            mgLabels.push(`(${mg} mg)`);
            dayIndex++;
          } else {
            dayLabels.push('');
            tabLabels.push('');
            mgLabels.push('');
          }
        }
        text += dayLabels.join(' | ') + '\n';
        text += tabLabels.join(' | ') + '\n';
        text += mgLabels.join(' | ') + '\n';
        if (dayIndex < days) text += '\n';
      }
      return text.trim();
    }

    // Main calculation and UI update
    document.getElementById('calculate').addEventListener('click', () => {
      const bsa = parseFloat(document.getElementById('bsa').value);
      const mgPerM2Day = parseFloat(document.getElementById('mg-per-m2-day').value);
      const days = parseInt(document.getElementById('days').value, 10);
      const tabletSize = parseFloat(document.getElementById('tablet-size').value);
      const mode = document.getElementById('schedule-mode').value;
      if (isNaN(bsa) || isNaN(mgPerM2Day) || isNaN(days) || isNaN(tabletSize)) {
        alert('Please enter valid numeric values.');
        return;
      }
      if (bsa <= 0 || mgPerM2Day <= 0 || days <= 0 || tabletSize <= 0) {
        alert('Values must be positive.');
        return;
      }
      const mgPerDay = mgPerM2Day * bsa;
      const totalMg = mgPerDay * days;
      const low = Math.floor(mgPerDay / tabletSize);
      const high = Math.ceil(mgPerDay / tabletSize);
      const diffPerHighDay = (high - low) * tabletSize;
      let numHighDays;
      if (diffPerHighDay === 0) {
        numHighDays = 0;
      } else {
        const required = (totalMg - low * tabletSize * days) / diffPerHighDay;
        numHighDays = Math.round(required);
        if (numHighDays < 0) numHighDays = 0;
        if (numHighDays > days) numHighDays = days;
      }
      let perDayTabs = [];
      if (low === high) {
        perDayTabs = new Array(days).fill(low);
      } else {
        if (mode === 'front-load') {
          perDayTabs = Array(numHighDays).fill(high)
            .concat(Array(days - numHighDays).fill(low));
        } else if (mode === 'weekly-front-load') {
          const weeks = Math.floor(days / 7);
          const rem = days % 7;
          let k = Math.round(numHighDays / days * 7);
          const highDaysUsed = (kk) => kk * weeks + Math.min(rem, kk);
          if (highDaysUsed(k) > numHighDays) {
            while (k > 0 && highDaysUsed(k) > numHighDays) k--;
          } else if (highDaysUsed(k) < numHighDays) {
            while (k < 7 && highDaysUsed(k) < numHighDays) k++;
            if (highDaysUsed(k) > numHighDays) k--;
          }
          let remainingHigh = numHighDays;
          perDayTabs = [];
          for (let w = 0; w < weeks; w++) {
            const hiDays = Math.min(k, remainingHigh);
            const loDays = 7 - hiDays;
            for (let i = 0; i < hiDays; i++) perDayTabs.push(high);
            for (let i = 0; i < loDays; i++) perDayTabs.push(low);
            remainingHigh -= hiDays;
          }
          if (rem > 0) {
            const hiDaysRem = Math.min(k, remainingHigh, rem);
            const loDaysRem = rem - hiDaysRem;
            for (let i = 0; i < hiDaysRem; i++) perDayTabs.push(high);
            for (let i = 0; i < loDaysRem; i++) perDayTabs.push(low);
            remainingHigh -= hiDaysRem;
          }
        } else if (mode === 'alternating') {
          perDayTabs = new Array(days);
          if (numHighDays === 0) {
            perDayTabs.fill(low);
          } else if (numHighDays === days) {
            perDayTabs.fill(high);
          } else {
            for (let i = 0; i < days; i++) {
              perDayTabs[i] = (i % 2 === 0) ? high : low;
            }
            let currentHighCount = Math.ceil(days / 2);
            if (numHighDays < currentHighCount) {
              for (let i = days - 1; i >= 0 && currentHighCount > numHighDays; i--) {
                if (perDayTabs[i] === high) {
                  perDayTabs[i] = low;
                  currentHighCount--;
                }
              }
            } else if (numHighDays > currentHighCount) {
              for (let i = days - 1; i >= 0 && currentHighCount < numHighDays; i--) {
                if (perDayTabs[i] === low) {
                  perDayTabs[i] = high;
                  currentHighCount++;
                }
              }
            }
          }
        }
      }
      const totalPills = perDayTabs.reduce((a, b) => a + b, 0);
      const pharmacyLine = formatPharmacySnippet(perDayTabs, days);
      const mgPerM2Total = mgPerM2Day * days;
      const mgLow = low * tabletSize;
      const mgHigh = high * tabletSize;
      const approxTotalMg = perDayTabs.reduce((sum, t) => sum + t * tabletSize, 0);
      let providerSummary = '';
      providerSummary += 'INPUTS\n';
      providerSummary += ` - BSA: ${bsa.toFixed(2)} m^2\n`;
      providerSummary += ` - Dose (mg/m^2/day): ${mgPerM2Day.toFixed(2)}\n`;
      providerSummary += ` - Days: ${days}\n`;
      providerSummary += ` - Tablet size: ${tabletSize} mg\n\n`;
      providerSummary += 'DERIVED\n';
      providerSummary += ` - Total mg/m^2: ${mgPerM2Total.toFixed(2)}\n`;
      providerSummary += ` - mg/day: ${mgPerDay.toFixed(2)}\n`;
      providerSummary += ` - Approx. mg/day: ${mgLow.toFixed(2)} (lo) or ${mgHigh.toFixed(2)} (hi)\n`;
      providerSummary += ` - Tablets/day (exact): ${(mgPerDay / tabletSize).toFixed(4)}\n`;
      providerSummary += ` - Tablets/day: ${low} (lo) or ${high} (hi)\n\n`;
      providerSummary += 'ROUNDING MIX\n';
      providerSummary += ` - High days: ${numHighDays}\n`;
      providerSummary += ` - Low days: ${days - numHighDays}\n\n`;
      providerSummary += 'TOTALS\n';
      providerSummary += ` - Total mg (approx.): ${approxTotalMg.toFixed(2)} mg\n`;
      providerSummary += ` - Total tablets: ${totalPills}\n`;
      const calendarHtml = buildCalendar(perDayTabs, tabletSize);
      const calendarText = buildCalendarText(perDayTabs, tabletSize);
      const patientIntro = `This plan lasts ${days} day${days === 1 ? '' : 's'}. Each tablet is ${tabletSize} mg. On some day${days === 1 ? '' : 's'} you will take more tablets than others to match your dose.`;
      document.getElementById('provider-summary').textContent = providerSummary;
      document.getElementById('calendar-container').innerHTML = calendarHtml;
      document.getElementById('pharmacy-line').textContent = pharmacyLine;
      document.getElementById('totals').textContent = `Total tablets: ${totalPills}`;
      document.getElementById('results').dataset.summary = providerSummary;
      document.getElementById('results').dataset.pharmacy = pharmacyLine;
      document.getElementById('results').dataset.calendarText = calendarText;
      document.getElementById('results').dataset.patientIntro = patientIntro;
      document.getElementById('results').dataset.totalPills = totalPills;
      document.getElementById('results').style.display = '';
    });

    // Copy pharmacy Sig to clipboard
    document.getElementById('copy-pharmacy').addEventListener('click', async () => {
      const text = document.getElementById('pharmacy-line').textContent;
      try {
        await navigator.clipboard.writeText(text);
        alert('Sig copied to clipboard.');
      } catch (err) {
        alert('Failed to copy Sig: ' + err);
      }
    });

    // Export provider RTF
    document.getElementById('export-provider').addEventListener('click', () => {
      const summary = document.getElementById('results').dataset.summary || '';
      const pharmacy = document.getElementById('results').dataset.pharmacy || '';
      const calendarText = document.getElementById('results').dataset.calendarText || '';
      const totalPills = document.getElementById('results').dataset.totalPills || '';
      const rtf = generateProviderRtf('Chemotherapy Calculator Calendar', summary, pharmacy, calendarText, totalPills);
      const blob = new Blob([rtf], { type: 'application/rtf' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'provider_schedule.rtf';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 0);
    });

    // Export patient RTF
    document.getElementById('export-patient').addEventListener('click', () => {
      const patientIntro = document.getElementById('results').dataset.patientIntro || '';
      const calendarText = document.getElementById('results').dataset.calendarText || '';
      const totalPills = document.getElementById('results').dataset.totalPills || '';
      const rtf = generatePatientRtf(patientIntro, calendarText, totalPills);
      const blob = new Blob([rtf], { type: 'application/rtf' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'patient_schedule.rtf';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 0);
    });
  </script>
</body>
</html>